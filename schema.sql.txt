-- SCRIPT DE CRIAÇÃO DO BANCO DE DADOS - GESTÃO DE CURSOS
-- Execute este script no SQL Editor do seu projeto Supabase.

-- 1. CRIAÇÃO DE TIPOS (ENUMS)
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'user_role') THEN
        CREATE TYPE user_role AS ENUM ('ADMIN', 'OPERATOR');
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'student_status') THEN
        CREATE TYPE student_status AS ENUM ('CURSANDO', 'APROVADO', 'REPROVADO', 'DESISTENTE');
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'course_period') THEN
        CREATE TYPE course_period AS ENUM ('Manhã', 'Tarde', 'Noite');
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'course_status') THEN
        CREATE TYPE course_status AS ENUM ('Ativo', 'Inativo', 'Concluído');
    END IF;
END$$;

-- 2. TABELA DE PARCEIROS
CREATE TABLE IF NOT EXISTS partners (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    company_name TEXT NOT NULL,
    responsible TEXT NOT NULL,
    contact TEXT NOT NULL,
    address TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. TABELA DE PROFESSORES
CREATE TABLE IF NOT EXISTS teachers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    contact TEXT NOT NULL,
    specialization TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. TABELA DE CURSOS
CREATE TABLE IF NOT EXISTS courses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    workload INTEGER NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    period course_period NOT NULL,
    location TEXT NOT NULL,
    status course_status DEFAULT 'Ativo',
    partner_id UUID REFERENCES partners(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. RELAÇÃO CURSO x PROFESSOR
CREATE TABLE IF NOT EXISTS course_teachers (
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
    teacher_id UUID REFERENCES teachers(id) ON DELETE CASCADE,
    PRIMARY KEY (course_id, teacher_id)
);

-- 6. TABELA DE ALUNOS
CREATE TABLE IF NOT EXISTS students (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    cpf TEXT UNIQUE NOT NULL,
    contact TEXT NOT NULL,
    birth_date DATE NOT NULL,
    address TEXT NOT NULL,
    status student_status DEFAULT 'CURSANDO',
    class CHAR(1),
    course_id UUID REFERENCES courses(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 7. TABELA DE USUÁRIOS
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role user_role DEFAULT 'OPERATOR',
    is_online BOOLEAN DEFAULT FALSE,
    last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 8. DADOS INICIAIS
INSERT INTO users (name, username, password, role) 
VALUES 
('Claudio A. Sousa', 'claudioasousa', 'cas661010', 'ADMIN'),
('Administrador', 'admin', 'admin', 'ADMIN'),
('Admin Teste', 'admin_teste', 'admin123', 'ADMIN')
ON CONFLICT (username) DO NOTHING;